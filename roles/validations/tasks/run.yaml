---
- name: Run validations
  register: run_validation
  shell:
    cmd: >-
      {{ validation_command }} run --validation {{ name.key }}
      {{ validation_dir }} {{ ansible_dir }}
      --inventory {{ inventory }}
      --output-log validation_{{ name.key }}.log
      {{ name.value.extra_args }}
      {{ name.value.extra_env_args }}
    executable: /bin/bash

- name: Get Run results
  block:
    - name: Get run results
      register: result
      shell:
        cmd: "cat validation_{{ name.key }}.log"
        executable: /bin/bash

    - name: Get json data
      set_fact:
        jsondata: "{{ result.stdout | from_json }}"

    - name: Get Validations Status
      set_fact:
        status: "{{ jsondata | json_query(jsonres) }}"
      vars:
        jsonres: 'results[*].Status'

    - fail:
        msg: "Validation failed: some of the validations has failed."
      when:
        - item != "PASSED"
      loop: "{{ status }}"
