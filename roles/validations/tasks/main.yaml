---
- name: Remove user local log dir to ensure clean env
  become: true
  file:
    path: "{{ ansible_user_dir }}/validations"
    state: absent

- name: Recreate user local log dir
  become: true
  file:
    path: "{{ ansible_user_dir }}/validations"
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true

- name: Ensure validations Log dir exists
  become: true
  file:
    path: "{{ vf_log_dir }}"
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true

- name: check if virtualenv is used
  register: is_virtualenv
  stat:
    path: "{{ zuul_work_virtualenv }}"

- name: Set commmand if virtualenv exists
  set_fact:
    validation_command: "source {{ zuul_work_virtualenv }}/bin/activate; {{ cli_command }}"
  when:
    - is_virtualenv.stat.exists
    - validation_command is not defined

- name: Set Validation directory if virtualenv exists
  set_fact:
    validation_dir: "{{ zuul_work_virtualenv }}/share/ansible/validation-playbooks"
  when: is_virtualenv.stat.exists

- name: Set Validation directory argument if virtualenv exists
  set_fact:
    validation_dir_arg: "--validation-dir {{ validation_dir }}"
  when: is_virtualenv.stat.exists

- name: Set Ansible base directory path if virtualenv exists
  set_fact:
    ansible_dir: "{{ zuul_work_virtualenv }}/share/ansible/"
  when: is_virtualenv.stat.exists

- name: Set Ansible base directory argument if virtualenv exists
  set_fact:
    ansible_dir_arg: "--ansible-base-dir {{ ansible_dir }}"
  when: is_virtualenv.stat.exists

- name: Set commmand without virtualenv
  set_fact:
    validation_command: "{{ cli_command }}"
  when:
    - not is_virtualenv.stat.exists
    - validation_command is not defined

- name: Set validation dir without virtualenv
  set_fact:
    validation_dir: "/usr/share/ansible/validation-playbooks"
  when: not is_virtualenv.stat.exists

- name: Set validation dir argument without virtualenv
  set_fact:
    validation_dir_arg: "--validation-dir {{ validation_dir }}"
  when: not is_virtualenv.stat.exists

- name: Set Ansible base directory path withnout virtualenv
  set_fact:
    ansible_dir: "/usr/share/ansible/"
  when: not is_virtualenv.stat.exists

- name: Set Ansible base directory argument withnout virtualenv exists
  set_fact:
    ansible_dir_arg: "--ansible-base-dir {{ ansible_dir }}"
  when: not is_virtualenv.stat.exists

- name: Set a valid inventory
  block:
    - name: Stat all possible inventory location
      register: stat_results
      stat:
        path: '{{ inv_path }}'
      loop: '{{ inventory_list }}'
      loop_control:
        loop_var: inv_path

    - name: Set inventory path or fallback to default localhost
      set_fact:
        inventory_path: '{{ stat_result.inv_path }}'
      when:
        - '{{ stat_result.stat.exists }}'
      loop: '{{ stat_results.results }}'
      loop_control:
        loop_var: stat_result

    - name: Set inventory variable
      set_fact:
        inventory: '{{ inventory_path|default("localhost") }}'
  when: inventory == ""

- name: Run positive validation tests
  include_tasks: run.yaml
  vars:
    name: "{{ item }}"
    expected_rc: 0
  when:
    - run_validation|default(false)|bool
    - validation_component | length > 0
  with_dict: "{{ validations_list[validation_component] }}"

- name: Fail if something went wrong
  fail:
    msg: "One or more Validations has failed, check the log results for more information."
  when: result_failed | default(False) | bool

- name: Run negative validation tests
  include_tasks: run.yaml
  vars:
    name: "{{ item }}"
    expected_rc: 1
    negative: true
  when:
    - run_validation|default(false)|bool
    - validation_component | length > 0
  with_dict: "{{ validations_list[validation_component] }}"

- name: Fail if something went wrong
  fail:
    msg: "One or more Validations has failed, check the log results for more information."
  when: result_failed | default(False) | bool

- name: List validations
  include_tasks: list.yaml
  vars:
    val_format: "{{ tested_format }}"
  loop: "{{ validation_list_formats }}"
  loop_control:
    loop_var: tested_format

- name: Show validation run results
  include_tasks: show_results.yaml
  vars:
    name: "{{ item }}"
  when:
    - run_validation|default(false)|bool
    - validation_component | length > 0
  with_dict: "{{ validations_list[validation_component] }}"

- name: Show validation
  include_tasks: show_validation_info.yaml
  vars:
    name: "{{ item }}"
  when:
    - run_validation|default(false)|bool
    - validation_component | length > 0
  with_dict: "{{ validations_list[validation_component] }}"

- name: List history
  include_tasks: list_validation_history.yaml
  vars:
    history_command: "{{'show history' if validation_command == 'openstack tripleo validator' else 'history list'}}"

- name: Run validations with extra vars file
  include_tasks: run_extra_vars_file.yaml
  vars:
    name: "{{ item }}"
    extra_vars_uuid: "{{ 'extra vars for tests' | to_uuid }}"
  when:
    - run_validation|default(false)|bool
    - validation_component | length > 0
  with_dict: "{{ validations_list[validation_component] }}"

- name: Import variable overrides
  become: true
  copy:
    src: files/catalog_vars_override.yaml
    dest: "{{ vf_catalogue_overrides }}"
    mode: "0644"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Execute entire validations catalogue
  include_tasks: execute_full_catalogue.yaml
  when: execute_full_vf_catalogue

- debug:
    msg: "{{ item }}"
  loop: "{{ test_arguments_run_from_file }}"

- name: Check if the File command is present
  register: subcommand_list
  shell:
    cmd: >-
      {{ validation_command }} --help
    executable: /bin/bash

- name: Execute the file command tests
  block:
    - name: Copy files to run
      template:
        src: './templates/file-template.j2'
        dest: rendered_file_{{ ansible_loop.index }}.yaml
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ test_arguments_run_from_file }}"
      loop_control:
        extended: true
      register: rendered_files

    - name: Run validations from the File
      include_tasks: file.yaml
      vars:
        files: "{{ rendered_files.results | map(attribute='dest') | list }}"
  when: "'Include and exclude validations by' in subcommand_list.stdout"

- name: Fail if something went wrong
  fail:
    msg: "One or more file runs have failed, check the log results for more information."
  when: files_test_failure | default(False) | bool and "'file' in subcommand_list.stdout"
